# ðŸ•·ï¸ è‡ªåŠ¨æŠ“å–çŸ¥ä¹Žçƒ­æ¦œ
name: è‡ªåŠ¨æŠ“å–çŸ¥ä¹Žçƒ­æ¦œ

on:
  # å®šæ—¶è§¦å‘ï¼ˆæ¯30åˆ†é’Ÿï¼‰
  schedule:
    - cron: '0 */30 * * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶ä¹Ÿå¯è§¦å‘ï¼ˆæµ‹è¯•ç”¨ï¼‰
  push:
    branches:
      - main
    paths:
      - '.github/workflows/fetch-hot.yml'
      - 'scripts/fetch.js'

# æƒé™é…ç½®
permissions:
  contents: write

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²

      # 2. è®¾ç½® Node.js
      - name: âš™ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          npm install axios

      # 4. æ‰§è¡ŒæŠ“å–
      - name: ðŸ•·ï¸ æ‰§è¡ŒæŠ“å–è„šæœ¬
        run: node scripts/fetch.js

      # 5. é…ç½® Git
      - name: ðŸ”§ é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 6. æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      - name: ðŸ” æ£€æŸ¥å˜åŒ–
        id: check_changes
        run: |
          if git diff --quiet data/zhihu-hot.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ•°æ®å˜åŒ–"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ•°æ®å˜åŒ–"
          fi

      # 7. æäº¤å’ŒæŽ¨é€
      - name: ðŸ’¾ æäº¤æ•°æ®
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add data/zhihu-hot.json
          git commit -m "chore: æ›´æ–°çŸ¥ä¹Žçƒ­æ¦œæ•°æ® $(date '+%Y-%m-%d %H:%M')"
          git push

      # 8. æ€»ç»“
      - name: ðŸ“Š æ€»ç»“
        if: always()
        run: |
          echo "## æŠ“å–ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- çŠ¶æ€: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- æ•°æ®: âœ… å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "- æ•°æ®: âš ï¸ æ— å˜åŒ–" >> $GITHUB_STEP_SUMMARY
          fi
